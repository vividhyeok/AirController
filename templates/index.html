<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Air Controller Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0c0c0c;
            --surface-color: rgba(30, 30, 30, 0.7);
            --surface-variant: rgba(45, 45, 45, 0.6);
            --primary-color: #74b9ff;
            --primary-glow: rgba(116, 185, 255, 0.3);
            --accent-color: #a29bfe;
            --text-primary: #ffffff;
            --text-secondary: #b2bec3;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-blur: 15px;
            --radius-lg: 28px;
            --radius-md: 18px;
            --radius-sm: 12px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Outfit', 'Noto Sans KR', -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(116, 185, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(162, 155, 254, 0.05) 0%, transparent 40%);
            color: var(--text-primary);
            margin: 0;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            position: relative;
            height: 100%;
        }

        /* Top Bar */
        .topbar {
            padding: calc(var(--safe-top) + 16px) 24px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .app-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 30%, var(--primary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            backdrop-filter: blur(5px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ff7675;
            box-shadow: 0 0 10px rgba(255, 118, 117, 0.5);
        }

        .status-badge.connected .status-dot {
            background-color: #55efc4;
            box-shadow: 0 0 10px rgba(85, 239, 196, 0.5);
        }

        /* Panels */
        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .panel {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: var(--transition);
            padding: 0 20px 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .panel.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        /* Touchpad */
        .touchpad-container {
            flex: 1;
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            position: relative;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(var(--glass-blur));
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            touch-action: none;
        }

        .touch-pattern {
            position: absolute;
            inset: 0;
            opacity: 0.05;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .scroll-strip {
            position: absolute;
            top: 10px;
            bottom: 10px;
            right: 10px;
            width: 40px;
            /* ëŒ€í­ í™•ì¥ */
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.1);
            font-size: 10px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            pointer-events: none;
            /* í„°ì¹˜ ì´ë²¤íŠ¸ëŠ” touchpad-containerì—ì„œ ì²˜ë¦¬ */
        }

        .scroll-strip::after {
            content: "SCROLL AREA";
            letter-spacing: 2px;
        }

        .touch-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
            opacity: 0.5;
            white-space: nowrap;
        }

        .mouse-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            height: 70px;
            margin-bottom: 10px;
        }

        /* Buttons */
        .btn-mouse {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(var(--glass-blur));
            transition: var(--transition);
        }

        .btn-mouse:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.1);
        }

        .control-grid,
        .grid-shortcuts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }

        .card-btn {
            background: var(--surface-variant);
            border-radius: var(--radius-md);
            padding: 18px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .card-btn:active {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(0.95);
            border-color: var(--primary-color);
        }

        .card-icon {
            font-size: 24px;
        }

        .card-label {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            opacity: 0.9;
        }

        /* Section Header with Toggle */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 24px 0 12px 4px;
            cursor: pointer;
        }

        .section-header h2 {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin: 0;
            font-weight: 700;
        }

        .toggle-icon {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsed+.collapsible-content {
            display: none;
        }

        /* Inputs */
        .text-input-row {
            background: var(--surface-color);
            border-radius: var(--radius-md);
            padding: 8px;
            display: flex;
            gap: 8px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(var(--glass-blur));
        }

        input[type="text"] {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            padding: 8px 12px;
            font-size: 16px;
            outline: none;
            min-width: 0;
        }

        .btn-send-full {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: #fff;
            border: none;
            border-radius: var(--radius-md);
            padding: 16px;
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 4px 15px var(--primary-glow);
            transition: var(--transition);
            text-align: center;
        }

        .btn-action-dark {
            background: var(--surface-variant);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            font-weight: 600;
        }

        /* Nav Tab Bar */
        .tab-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 12px 12px calc(var(--safe-bottom) + 12px);
            background: rgba(12, 12, 12, 0.82);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 0 0 4px 4px;
            box-shadow: 0 0 10px var(--primary-color);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            background-color: currentColor;
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
        }

        /* Site List */
        .site-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .site-item {
            display: flex;
            align-items: center;
            background: var(--surface-variant);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            gap: 12px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .site-icon-box {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .site-info {
            flex: 1;
            overflow: hidden;
            cursor: pointer;
        }

        .site-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .site-url {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            margin-top: 2px;
        }

        .site-actions {
            display: flex;
            gap: 8px;
        }

        .btn-site-action {
            background: transparent;
            border: none;
            padding: 6px;
            font-size: 16px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .btn-site-action:active {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            width: 100%;
            max-width: 400px;
            border-radius: var(--radius-lg);
            padding: 28px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .choice-btn {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--surface-variant);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: #fff;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .choice-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .choice-icon {
            font-size: 20px;
        }

        .choice-text div:first-child {
            font-weight: 600;
            font-size: 14px;
        }

        .choice-text div:last-child {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 2px;
        }

        /* Range Wrap */
        .range-wrap {
            background: var(--surface-color);
            padding: 18px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .range-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        input[type=range] {
            width: 100%;
            height: 6px;
            background: #2d3436;
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-glow);
            cursor: pointer;
        }

        /* Icons */
        .icon-touch {
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C9.5 2 7.2 3.2 5.8 5.3L12 14L18.2 5.3C16.8 3.2 14.5 2 12 2ZM4.9 6.7C3.1 8 2 10.1 2 12.5C2 17.5 5.8 21.6 10.8 22H13.2C18.2 21.6 22 17.5 22 12.5C22 10.1 20.9 8 19.1 6.7L12 16.5L4.9 6.7Z" fill="black"/></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C9.5 2 7.2 3.2 5.8 5.3L12 14L18.2 5.3C16.8 3.2 14.5 2 12 2ZM4.9 6.7C3.1 8 2 10.1 2 12.5C2 17.5 5.8 21.6 10.8 22H13.2C18.2 21.6 22 17.5 22 12.5C22 10.1 20.9 8 19.1 6.7L12 16.5L4.9 6.7Z" fill="black"/></svg>');
        }

        .icon-input {
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6V18H20V6H4ZM2 6C2 4.9 2.9 4 4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6ZM6 8H8V10H6V8ZM6 12H8V14H6V12ZM10 8H14V10H10V8ZM10 12H14V14H10V12ZM16 8H18V10H16V8ZM16 12H18V14H16V12Z" fill="black"/></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6V18H20V6H4ZM2 6C2 4.9 2.9 4 4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6ZM6 8H8V10H6V8ZM6 12H8V14H6V12ZM10 8H14V10H10V8ZM10 12H14V14H10V12ZM16 8H18V10H16V8ZM16 12H18V14H16V12Z" fill="black"/></svg>');
        }

        .icon-apps {
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4H10V10H4V4ZM14 4H20V10H14V4ZM4 14H10V20H4V14ZM14 14H20V20H14V14Z" fill="black"/></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4H10V10H4V4ZM14 4H20V10H14V4ZM4 14H10V20H4V14ZM14 14H20V20H14V14Z" fill="black"/></svg>');
        }

        /* Utility */
        .mt-auto {
            margin-top: auto;
        }

        .pt-10 {
            padding-top: 10px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Top Bar -->
        <div class="topbar">
            <div class="app-title">Air Controller Pro</div>
            <div style="display:flex; gap:12px; align-items:center;">
                <div class="status-badge" id="statusBadge">
                    <div class="status-dot"></div>
                    <span id="statusText">ì—°ê²° ëŒ€ê¸°ì¤‘</span>
                </div>
                <button class="btn-mouse"
                    style="width:36px; height:36px; padding:0; border:none; background:transparent; font-size:20px;"
                    onclick="showSettingsModal()">âš™ï¸</button>
            </div>
        </div>

        <div class="content">
            <!-- Panel: Touchpad -->
            <div class="panel active" id="panel-touch">
                <div class="touchpad-container" id="touchpad">
                    <div class="touch-pattern"></div>
                    <div class="scroll-strip"></div>
                    <div class="touch-hint">ì´ê³³ì„ í„°ì¹˜í•˜ì—¬ ë§ˆìš°ìŠ¤ ì¡°ì‘<br>ì˜¤ë¥¸ìª½ íšŒìƒ‰ ë°”ë¥¼ ë°€ì–´ ìŠ¤í¬ë¡¤</div>
                </div>
                <div class="mouse-controls">
                    <div class="btn-mouse" onclick="emitClick('left')">ì™¼ìª½ í´ë¦­</div>
                    <div class="btn-mouse" onclick="emitClick('right')">ì˜¤ë¥¸ìª½ í´ë¦­</div>
                </div>
            </div>

            <!-- Panel: Inputs & Controls -->
            <div class="panel" id="panel-input">
                <div class="section-header">
                    <h2>ë¯¸ë””ì–´ ì»¨íŠ¸ë¡¤</h2>
                </div>
                <div class="control-grid">
                    <div class="card-btn" data-ai-id="rewd" onclick="emitKey('left')"><span
                            class="card-icon">âª</span><span class="card-label">-5s</span></div>
                    <div class="card-btn" data-ai-id="playpause" onclick="emitKey('playpause')"><span
                            class="card-icon">â¯</span><span class="card-label">ì¬ìƒ/ì¼ì‹œì •ì§€</span></div>
                    <div class="card-btn" data-ai-id="fwd" onclick="emitKey('right')"><span
                            class="card-icon">â©</span><span class="card-label">+5s</span></div>
                    <div class="card-btn" data-ai-id="volumedown" onclick="emitKey('volumedown')"><span
                            class="card-icon">ğŸ”‰</span><span class="card-label">ë³¼ë¥¨ -</span></div>
                    <div class="card-btn" data-ai-id="volumemute" onclick="emitKey('volumemute')"><span
                            class="card-icon">ğŸ”‡</span><span class="card-label">ìŒì†Œê±°</span></div>
                    <div class="card-btn" data-ai-id="volumeup" onclick="emitKey('volumeup')"><span
                            class="card-icon">ğŸ”Š</span><span class="card-label">ë³¼ë¥¨ +</span></div>
                    <div class="card-btn" data-ai-id="prev" onclick="emitKey('prevtrack')"><span
                            class="card-icon">â®</span><span class="card-label">ì´ì „ ê³¡</span></div>
                    <div class="card-btn" data-ai-id="space" onclick="emitKey('space')"><span
                            class="card-icon">â£</span><span class="card-label">ìŠ¤í˜ì´ìŠ¤</span></div>
                    <div class="card-btn" data-ai-id="next" onclick="emitKey('nexttrack')"><span
                            class="card-icon">â­</span><span class="card-label">ë‹¤ìŒ ê³¡</span></div>
                </div>

                <div class="section-header">
                    <h2>ë¸Œë¼ìš°ì € ì œì–´</h2>
                </div>
                <div class="control-grid">
                    <div class="card-btn" data-ai-id="refresh" onclick="emitKey('f5')"><span
                            class="card-label">ìƒˆë¡œê³ ì¹¨</span></div>
                    <div class="card-btn" data-ai-id="fullscreen" onclick="emitKey('f')"><span
                            class="card-label">ì „ì²´í™”ë©´</span></div>
                    <div class="card-btn" data-ai-id="back" onclick="emitHotkey(['alt', 'left'])"><span
                            class="card-label">ë’¤ë¡œê°€ê¸°</span>
                    </div>
                    <div class="card-btn" data-ai-id="forward" onclick="emitHotkey(['alt', 'right'])"><span
                            class="card-label">ì•ìœ¼ë¡œê°€ê¸°</span>
                    </div>
                    <div class="card-btn" onclick="emitHotkey(['ctrl', 't'])"><span class="card-label">ìƒˆ íƒ­</span></div>
                    <div class="card-btn" onclick="emitHotkey(['ctrl', 'w'])"><span class="card-label">íƒ­ ë‹«ê¸°</span></div>
                    <div class="card-btn" onclick="emitHotkey(['ctrl', 'shift', 'tab'])"><span class="card-label">ì´ì „
                            íƒ­</span></div>
                    <div class="card-btn" onclick="emitHotkey(['ctrl', 'tab'])"><span class="card-label">ë‹¤ìŒ íƒ­</span>
                    </div>
                    <div class="card-btn" onclick="emitKey('browserhome')"><span class="card-label">í™ˆ</span></div>
                </div>

                <div class="section-header">
                    <h2>í…ìŠ¤íŠ¸ ì…ë ¥</h2>
                </div>
                <div class="text-input-row" style="margin-bottom:12px;">
                    <input type="text" id="textInput" placeholder="ì…ë ¥í•  ë‚´ìš©ì„ ì ìœ¼ì„¸ìš”...">
                    <button class="btn-mouse" style="width:48px; border:none;" onclick="showVoiceModal()">ğŸ¤</button>
                </div>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 10px; margin-bottom: 24px;">
                    <button class="btn-send-full" onclick="sendText()">ì…ë ¥ ì „ì†¡</button>
                    <button class="btn-action-dark" onclick="emitKey('enter')">ì—”í„°</button>
                    <button class="btn-action-dark" onclick="emitKey('backspace')">ì§€ìš°ê¸°</button>
                </div>

                <div class="section-header">
                    <h2>ì„¤ì •</h2>
                </div>
                <div class="range-wrap">
                    <div class="range-header"><span>ë§ˆìš°ìŠ¤ ê°ë„</span><span id="mouseVal">2.5</span></div>
                    <input type="range" id="mouseSens" min="1.0" max="5.0" step="0.5" value="2.5">
                </div>
                <div class="range-wrap" style="margin-bottom:20px;">
                    <div class="range-header"><span>ìŠ¤í¬ë¡¤ ê°ë„</span><span id="scrollVal">15</span></div>
                    <input type="range" id="scrollSens" min="5" max="50" step="5" value="15">
                </div>

                <button class="btn-action-dark" style="color:#ff7675; border-color: rgba(255,118,117,0.2);"
                    onclick="showTimerModal()">ğŸ’¤ PC ì˜ˆì•½ ì¢…ë£Œ ì„¤ì •</button>
            </div>

            <!-- Panel: Apps -->
            <div class="panel" id="panel-apps">
                <div id="aiAnalysisBox" style="margin-bottom: 20px; display:none;">
                    <div class="section-header">
                        <h2>ì‹¤ì‹œê°„ ì‚¬ì´íŠ¸ ë¶„ì„</h2>
                    </div>
                    <div class="card-btn"
                        style="background: linear-gradient(135deg, rgba(162, 155, 254, 0.1), rgba(116, 185, 255, 0.1)); border-color: var(--accent-color);"
                        onclick="analyzeCurrentSite()">
                        <span class="card-icon">ğŸ§ </span>
                        <span class="card-label">í˜„ì¬ ì‚¬ì´íŠ¸ ë¶„ì„ ë° ë²„íŠ¼ ë§¤í•‘</span>
                    </div>
                    <div id="mappingStatus"
                        style="font-size:11px; text-align:center; color:var(--primary-color); margin-top:8px;"></div>
                </div>

                <div class="section-header">
                    <h2>ì¦ê²¨ì°¾ê¸°</h2>
                </div>
                <div class="grid-shortcuts" id="favoritesGrid">
                    <!-- ì¦ê²¨ì°¾ê¸° ì•„ì´í…œ ë™ì  ìƒì„± -->
                </div>

                <div class="section-header">
                    <h2>URL ì§ì ‘ ì—´ê¸°</h2>
                </div>
                <div class="text-input-row" style="margin-bottom:24px;">
                    <input type="text" id="appUrlInput" placeholder="https://...">
                    <button class="btn-mouse" style="padding: 0 16px; border:none;" onclick="openAppUrl()">ì´ë™</button>
                </div>

                <div class="section-header collapsed" onclick="toggleHistory(this)">
                    <h2>ìµœê·¼ ë°©ë¬¸ ê¸°ë¡</h2>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="collapsible-content">
                    <div class="site-list" id="historyList">
                        <!-- íˆìŠ¤í† ë¦¬ ì•„ì´í…œ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <div class="mt-auto pt-10">
                    <button class="btn-send-full" style="width:100%;" onclick="syncFromPc()">ğŸ”„ PC í™”ë©´ ë‚´ í°ìœ¼ë¡œ ë™ê¸°í™”</button>
                </div>
            </div>
        </div>

        <!-- Navigation Tab Bar -->
        <div class="tab-bar">
            <div class="nav-item active" onclick="switchTab('touch')">
                <div class="nav-icon icon-touch"></div>
                <span>í„°ì¹˜</span>
            </div>
            <div class="nav-item" onclick="switchTab('input')">
                <div class="nav-icon icon-input"></div>
                <span>ì»¨íŠ¸ë¡¤</span>
            </div>
            <div class="nav-item" onclick="switchTab('apps')">
                <div class="nav-icon icon-apps"></div>
                <span>ì•± / ì‚¬ì´íŠ¸</span>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Timer Modal -->
    <div class="modal-overlay" id="timerModal">
        <div class="modal-content">
            <div class="modal-title">PC ì˜ˆì•½ ì¢…ë£Œ</div>
            <div class="preset-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn-mouse" style="height:46px;" onclick="setTimer(20)">20ë¶„ í›„</button>
                <button class="btn-mouse" style="height:46px;" onclick="setTimer(40)">40ë¶„ í›„</button>
                <button class="btn-mouse" style="height:46px;" onclick="setTimer(60)">1ì‹œê°„ í›„</button>
                <button class="btn-mouse" style="height:46px;" onclick="setTimer(120)">2ì‹œê°„ í›„</button>
            </div>
            <div class="text-input-row">
                <input type="text" id="manualMinutes" placeholder="ì…ë ¥ (ë‹¨ìœ„: ë¶„)">
                <button class="btn-mouse" style="padding:0 12px;" onclick="setManualTimer()">ì˜ˆì•½</button>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-action-dark" style="flex:1" onclick="closeModals()">ì·¨ì†Œ</button>
                <button class="btn-action-dark" style="flex:1; color:#ff7675;" onclick="cancelShutdown()">ì˜ˆì•½ ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Starring Choice Modal -->
    <div class="modal-overlay" id="starChoiceModal">
        <div class="modal-content">
            <div class="modal-title">ì¦ê²¨ì°¾ê¸° ì €ì¥ ë°©ì‹ ì„ íƒ</div>
            <div id="choiceContainer"></div>
            <button class="btn-action-dark" style="width:100%; margin-top:10px;" onclick="closeModals()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- Favorite Edit Modal -->
    <div class="modal-overlay" id="favEditModal">
        <div class="modal-content">
            <div class="modal-title">ì¦ê²¨ì°¾ê¸° ì •ë³´ í¸ì§‘</div>
            <div class="text-input-row" style="margin-bottom:10px;">
                <input type="text" id="favNameInput" placeholder="ì´ë¦„ (ì˜ˆ: ìœ íŠœë¸Œ)">
            </div>
            <div class="text-input-row" style="margin-bottom:15px;">
                <input type="text" id="favIconInput" placeholder="ì´ëª¨ì§€ ë˜ëŠ” ì•„ì´ì½˜ (ì˜ˆ: ğŸ¬)">
            </div>
            <div id="favUrlLabel" style="font-size:11px; color:#666; margin-bottom:20px; word-break:break-all;"></div>
            <button class="btn-send-full" style="width:100%;" id="saveFavBtn">ì €ì¥í•˜ê¸°</button>
            <button class="btn-action-dark" style="width:100%; margin-top:10px;" onclick="closeModals()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- Voice Modal -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal-content" style="text-align:center;">
            <div class="modal-title">ë§ì”€í•´ ì£¼ì„¸ìš”...</div>
            <div id="voiceResult"
                style="font-size:18px; font-weight:600; min-height:1.5em; color:var(--primary-color); margin:20px 0;">
            </div>
            <button class="btn-action-dark" style="width:100%;" onclick="closeModals()">ì¤‘ë‹¨</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">AI ë° ì•± ì„¤ì •</div>

            <div class="section-header">
                <h2>AI ë¶„ì„ ê¸°ëŠ¥ ì‚¬ìš©</h2>
            </div>
            <label class="choice-btn" style="padding:12px; cursor:pointer;">
                <input type="checkbox" id="aiEnabledToggle" onchange="toggleAiPower()" style="width:20px; height:20px;">
                <div class="choice-text">
                    <div>AI ë²„íŠ¼ ìë™ ë§¤í•‘ í™œì„±í™”</div>
                    <div>ì²´í¬ í•´ì œ ì‹œ ê´€ë ¨ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.</div>
                </div>
            </label>

            <div id="aiConfigInputs" style="opacity:0.5; pointer-events:none; transition:0.3s;">
                <div class="section-header">
                    <h2>ëª¨ë¸ ì„ íƒ</h2>
                </div>
                <div class="choice-btn" style="padding:10px; flex-direction:column; gap:8px;">
                    <select id="aiModelSelect"
                        style="width:100%; height:40px; background:var(--surface-color); color:#fff; border-radius:8px; border:1px solid var(--border-color); outline:none; padding:0 10px;">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (ì¶”ì²œ/ì €ë ´)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="deepseek-chat">DeepSeek Chat</option>
                    </select>
                </div>

                <div class="section-header">
                    <h2>API í‚¤ ì…ë ¥</h2>
                </div>
                <div class="text-input-row" style="margin-bottom:8px;">
                    <input type="password" id="key-google" placeholder="Google AI API Key">
                </div>
                <div class="text-input-row" style="margin-bottom:8px;">
                    <input type="password" id="key-openai" placeholder="OpenAI API Key">
                </div>
                <div class="text-input-row" style="margin-bottom:15px;">
                    <input type="password" id="key-deepseek" placeholder="DeepSeek API Key">
                </div>

                <div class="section-header">
                    <h2>ì‚¬ìš©ëŸ‰ ë° ë¹„ìš© (KRW)</h2>
                </div>
                <div class="range-wrap" style="padding:12px; font-size:13px; font-weight:500;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                        <span>ìµœê·¼ ë¶„ì„ ë¹„ìš©</span><span id="lastCost" style="color:var(--primary-color);">â‚©0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>ëˆ„ì  í•©ê³„</span><span id="totalCost" style="color:var(--accent-color);">â‚©0</span>
                    </div>
                </div>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-action-dark" style="flex:1" onclick="closeModals()">ë‹«ê¸°</button>
                <button class="btn-send-full" style="flex:1" onclick="saveAiSettings()">ì„¤ì • ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');

        socket.on('connect', () => { statusBadge.classList.add('connected'); statusText.textContent = 'ì—°ê²°ë¨'; socket.emit('get_sites'); });
        socket.on('disconnect', () => { statusBadge.classList.remove('connected'); statusText.textContent = 'ì—°ê²° ëŠê¹€'; });
        socket.on('sync_sites', (data) => { renderSites(data); });
        socket.on('system_status', (data) => { alert(data.msg); });
        socket.on('open_on_mobile', (data) => { if (confirm('PCì—ì„œ ê°€ì ¸ì˜¨ í˜ì´ì§€ë¥¼ ì—´ê¹Œìš”?\n' + data.url)) window.open(data.url, '_blank'); });
        socket.on('domain_info', (data) => { showStarChoice(data); });

        socket.on('ai_config_status', (config) => {
            updateAiConfigUI(config);
        });

        socket.on('ai_mapping_result', (data) => {
            applyAiMapping(data);
        });

        socket.emit('get_ai_config');

        // Settings
        let mouseSens = localStorage.getItem('mouseSens') || 2.5, scrollSens = localStorage.getItem('scrollSens') || 15;
        document.getElementById('mouseSens').value = mouseSens; document.getElementById('mouseVal').textContent = mouseSens;
        document.getElementById('scrollSens').value = scrollSens; document.getElementById('scrollVal').textContent = scrollSens;
        document.getElementById('mouseSens').oninput = (e) => { mouseSens = e.target.value; document.getElementById('mouseVal').textContent = mouseSens; localStorage.setItem('mouseSens', mouseSens); };
        document.getElementById('scrollSens').oninput = (e) => { scrollSens = e.target.value; document.getElementById('scrollVal').textContent = scrollSens; localStorage.setItem('scrollSens', scrollSens); };

        // Tabs
        function switchTab(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${name}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');
            vibrate(10);
        }

        function toggleHistory(el) {
            el.classList.toggle('collapsed');
            vibrate(5);
        }

        // Common Emitters
        function emitClick(btn) { socket.emit('click', { btn }); vibrate(30); }
        function emitKey(key) { socket.emit('key', { key }); vibrate(15); }
        function emitHotkey(keys) { socket.emit('hotkey', { keys }); vibrate(20); }
        function openUrl(url) { socket.emit('open', { url }); vibrate(40); }

        function sendText() {
            const input = document.getElementById('textInput');
            if (input.value) { socket.emit('type', { text: input.value }); input.value = ''; vibrate(40); }
        }

        function openAppUrl() {
            const input = document.getElementById('appUrlInput');
            if (input.value) { let url = input.value.trim(); if (!/^https?:\/\//i.test(url)) url = 'https://' + url; openUrl(url); input.value = ''; }
        }

        function syncFromPc() { socket.emit('sync_from_pc'); vibrate(30); }

        // AI & Settings
        function showSettingsModal() { document.getElementById('settingsModal').classList.add('active'); socket.emit('get_ai_config'); }

        function updateAiConfigUI(config) {
            document.getElementById('aiEnabledToggle').checked = config.enabled;
            document.getElementById('aiModelSelect').value = config.selected_model;
            document.getElementById('key-google').value = config.api_keys.google || "";
            document.getElementById('key-openai').value = config.api_keys.openai || "";
            document.getElementById('key-deepseek').value = config.api_keys.deepseek || "";
            document.getElementById('lastCost').textContent = `â‚©${config.usage.last_cost.toLocaleString()}`;
            document.getElementById('totalCost').textContent = `â‚©${config.usage.total_krw.toLocaleString()}`;

            toggleAiInputs(config.enabled);
            document.getElementById('aiAnalysisBox').style.display = config.enabled ? 'block' : 'none';
        }

        function toggleAiPower() {
            const enabled = document.getElementById('aiEnabledToggle').checked;
            toggleAiInputs(enabled);
            if (!enabled) applyAiMapping({ mapping: null }); // Reset
        }

        function toggleAiInputs(enabled) {
            const container = document.getElementById('aiConfigInputs');
            container.style.opacity = enabled ? '1' : '0.5';
            container.style.pointerEvents = enabled ? 'auto' : 'none';
        }

        function saveAiSettings() {
            const data = {
                enabled: document.getElementById('aiEnabledToggle').checked,
                selected_model: document.getElementById('aiModelSelect').value,
                api_keys: {
                    google: document.getElementById('key-google').value,
                    openai: document.getElementById('key-openai').value,
                    deepseek: document.getElementById('key-deepseek').value
                }
            };
            socket.emit('save_ai_config', data);
            closeModals();
            vibrate(30);
        }

        function analyzeCurrentSite() {
            // í˜„ì¬ í™œì„±í™”ëœ ë¸Œë¼ìš°ì € URLì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ sync_from_pcì˜ ë¡œì§ ì¼ë¶€ í™œìš© (ì„œë²„ ì¸¡ êµ¬í˜„ í•„ìš”)
            document.getElementById('mappingStatus').textContent = "ì‚¬ì´íŠ¸ ë¶„ì„ ì¤‘... (ë¹„ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)";
            socket.emit('sync_from_pc_silent'); // Silent version to get URL without opening on mobile
            vibrate(20);
        }

        socket.on('pc_url_received', (data) => {
            if (data.url) socket.emit('analyze_site', { url: data.url });
        });

        function applyAiMapping(data) {
            const mapping = data.mapping;
            const statusEl = document.getElementById('mappingStatus');

            if (mapping) {
                statusEl.textContent = `ë¶„ì„ ì™„ë£Œ: ${mapping.site_name || data.url}`;
                statusEl.style.color = "#55efc4";
                vibrate([30, 50, 30]);
            } else {
                statusEl.textContent = "";
                statusEl.style.color = "var(--primary-color)"; // Reset color
            }

            // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™” í›„ ë§¤í•‘ ì ìš©
            const allAiButtons = document.querySelectorAll('.card-btn[data-ai-id]');
            allAiButtons.forEach(btn => {
                const aiId = btn.getAttribute('data-ai-id');
                if (!mapping) {
                    btn.style.opacity = "1";
                    btn.style.pointerEvents = "auto";
                    btn.style.borderColor = "var(--border-color)";
                    btn.style.boxShadow = "none"; // Reset shadow
                    // Reset onclick to original if possible, or a generic one
                    // For now, we'll just re-enable. A more robust solution would store original onclicks.
                    return;
                }

                if (mapping[aiId]) {
                    btn.style.opacity = "1";
                    btn.style.pointerEvents = "auto";
                    btn.style.borderColor = "var(--primary-color)";
                    btn.style.boxShadow = "0 0 10px var(--primary-glow)";
                    // ë‹¨ì¶•í‚¤ ì˜¤ë²„ë¼ì´ë“œ ë¡œì§ (í•„ìš” ì‹œ emitKey ìˆ˜ì •)
                    btn.onclick = () => { emitKey(mapping[aiId]); vibrate(20); };
                } else if (["refresh", "back", "forward"].includes(aiId)) {
                    // í•„ìˆ˜ ë¸Œë¼ìš°ì € ê¸°ëŠ¥ì€ ìœ ì§€
                    btn.style.opacity = "1";
                    btn.style.pointerEvents = "auto";
                    btn.style.borderColor = "var(--border-color)"; // Keep default border
                    btn.style.boxShadow = "none"; // No glow for unmapped but active
                } else {
                    // ë§¤í•‘ë˜ì§€ ì•Šì€ ë²„íŠ¼ ë¹„í™œì„±í™”
                    btn.style.opacity = "0.2";
                    btn.style.pointerEvents = "none";
                    btn.style.boxShadow = "none";
                    btn.style.borderColor = "transparent";
                }
            });
        }

        // Render Sites
        function renderSites(data) {
            const fGrid = document.getElementById('favoritesGrid');
            fGrid.innerHTML = '';
            data.favorites.forEach(fav => {
                const item = document.createElement('div');
                item.className = 'card-btn';
                item.innerHTML = `<span class="card-icon">${fav.icon || 'â­'}</span><span class="card-label">${fav.name}</span>`;
                item.onclick = () => openUrl(fav.url);
                // Long press for deletion? Simplified for now with an edit button maybe later.
                fGrid.appendChild(item);
            });

            const hList = document.getElementById('historyList');
            hList.innerHTML = '';
            data.history.forEach(site => {
                const item = document.createElement('div');
                item.className = 'site-item';
                const domain = extractDisplayDomain(site);
                item.innerHTML = `
                    <div class="site-icon-box">ğŸ”—</div>
                    <div class="site-info" onclick="openUrl('${site}')">
                        <span class="site-name">${domain}</span>
                        <span class="site-url">${site}</span>
                    </div>
                    <div class="site-actions">
                        <button class="btn-site-action" onclick="starHistory('${site}')">â­</button>
                        <button class="btn-site-action" onclick="deleteHistory('${site}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                hList.appendChild(item);
            });
        }

        function extractDisplayDomain(url) {
            try { return new URL(url).hostname; } catch (e) { return url; }
        }

        // Favorites Management
        function starHistory(url) {
            socket.emit('get_domain_info', { url });
            vibrate(20);
        }

        function showStarChoice(data) {
            const modal = document.getElementById('starChoiceModal');
            const container = document.getElementById('choiceContainer');
            container.innerHTML = `
                <button class="choice-btn" onclick="startFavEdit('${data.url}')">
                    <span class="choice-icon">ğŸ“„</span>
                    <div class="choice-text">
                        <div>ì´ í˜ì´ì§€ ì „ì²´ ì €ì¥</div>
                        <div>${data.url}</div>
                    </div>
                </button>
                <button class="choice-btn" onclick="startFavEdit('${data.domain}')">
                    <span class="choice-icon">ğŸ </span>
                    <div class="choice-text">
                        <div>ê¸°ë³¸ ë„ë©”ì¸ ì €ì¥</div>
                        <div>${data.domain}</div>
                    </div>
                </button>
            `;
            modal.classList.add('active');
        }

        function startFavEdit(url) {
            document.getElementById('starChoiceModal').classList.remove('active');
            const modal = document.getElementById('favEditModal');
            document.getElementById('favUrlLabel').textContent = url;
            document.getElementById('favNameInput').value = extractDisplayDomain(url);
            document.getElementById('favIconInput').value = 'â­';
            document.getElementById('saveFavBtn').onclick = () => saveFavorite(url);
            modal.classList.add('active');
        }

        function saveFavorite(url) {
            const name = document.getElementById('favNameInput').value || extractDisplayDomain(url);
            const icon = document.getElementById('favIconInput').value || 'â­';
            socket.emit('add_favorite', { name, url, icon });
            closeModals();
            vibrate(50);
        }

        function deleteHistory(url) { if (confirm('ì´ ë°©ë¬¸ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) { socket.emit('delete_site', { url, type: 'history' }); vibrate(20); } }

        // Modals
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); stopRecognition(); }
        function showTimerModal() { document.getElementById('timerModal').classList.add('active'); }
        function setTimer(min) { socket.emit('system', { action: 'timer', min }); closeModals(); }
        function setManualTimer() { const min = parseInt(document.getElementById('manualMinutes').value); if (min > 0) setTimer(min); else alert('ë¶„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
        function cancelShutdown() { socket.emit('system', { action: 'cancel_shutdown' }); closeModals(); }

        // STT
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = (SR) ? new SR() : null;
        if (recognition) {
            recognition.lang = 'ko-KR';
            recognition.onresult = (e) => { const t = e.results[0][0].transcript; document.getElementById('voiceResult').textContent = t; document.getElementById('textInput').value = t; setTimeout(closeModals, 1000); };
        }
        function showVoiceModal() { if (!recognition) return alert('ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.'); document.getElementById('voiceResult').textContent = ''; document.getElementById('voiceModal').classList.add('active'); recognition.start(); vibrate(20); }
        function stopRecognition() { if (recognition) try { recognition.stop(); } catch (e) { } }

        // Touchpad
        const touchpad = document.getElementById('touchpad');
        let lastX, lastY, isTouching, startTime, hasMoved, isScroll;
        touchpad.addEventListener('touchstart', (e) => {
            e.preventDefault(); isTouching = true; hasMoved = false; startTime = Date.now();
            const rect = touchpad.getBoundingClientRect(); const t = e.touches[0];
            const x = t.clientX - rect.left;
            isScroll = (x > rect.width - 50) || (e.touches.length === 2);
            lastX = t.clientX; lastY = t.clientY;
        }, { passive: false });
        touchpad.addEventListener('touchend', (e) => {
            e.preventDefault(); if (isTouching && !hasMoved && (Date.now() - startTime < 200)) emitClick(isScroll ? 'right' : 'left');
            isTouching = false;
        });
        touchpad.addEventListener('touchmove', (e) => {
            e.preventDefault(); if (!isTouching) return;
            const t = e.touches[0]; const dx = t.clientX - lastX, dy = t.clientY - lastY;
            if (Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) {
                hasMoved = true;
                if (isScroll) socket.emit('scroll', { dy: dy * (scrollSens / 5) });
                else socket.emit('move', { dx: dx * mouseSens, dy: dy * mouseSens });
                lastX = t.clientX; lastY = t.clientY;
            }
        }, { passive: false });

        function vibrate(ms) { if (navigator.vibrate) navigator.vibrate(ms); }
        document.getElementById('textInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') sendText(); });

        // Responsive Fix
        function adjustVH() { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
        window.addEventListener('resize', adjustVH); adjustVH();
    </script>
</body>

</html>